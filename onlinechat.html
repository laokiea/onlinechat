<!doctype html>
<head>
<meta charset="utf-8"/>
<title>在线聊天</title>
<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
<script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>

<style>
*{margin: 0;padding: 0;font-family: Arial, Helvetica, sans-serif,'宋体';}
html,body{overflow:hidden;width: 100%;height:100%;background: url("./GJDL_2.jpg") no-repeat;background-position: center 90%;background-size: cover;}
.header{height: 150px;line-height: 150px;letter-spacing: -2px;color: #FF7846;font-family: '微软雅黑';font-size:70px;display: block;text-align: center;margin: 10px 0 30px 0;}
p{margin: 0;}
#chat_table{width: 600px;height: 400px;margin: 0px auto;margin-top: 40px;box-shadow: 0px 0px 1px #A4D3EE;border-radius: 5px;background: url("./GJDL_3.jpg") no-repeat;background-position: center;background-size: cover;}
#chat_form{width: 100%;height: 100%;position:relative;}
#content_continer{width: 100%;height: 350px;overflow-y: scroll;padding-top: 8px;}
input.chat_content{width: 100%;height:50px;position:absolute;top: 350px;border:1px solid #EAEAEA;font-size:18px;}
#btn_submit{position: absolute;width: 50px;height: 30px;top: 360px;left: 530px;}
span[class^="_message"],span[class^="message_"]{color:	#282828;min-width:80px;text-align: center;letter-spacing:1px;display: inline-block;height: 40px;line-height: 40px;margin: 7px 14px 7px 15px;padding: 0px 20px; border-radius: 6px;border: 1px solid #dddddd;
background: url("20150806175243_VKPXa.thumb.700_0.jpg") no-repeat;background-position : 56% 29%;font-size:16px;}
</style>
</head>
<body>
<span class="text-center header">!chat</span>

<div class="modal fade" id="user_select" tabindex="-1" role="dialog" >
<div class="modal-dialog modal-sm">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal"><span>&times</span></button>
<h4>选择用户</h4>
</div>

<div class="modal-body">
	<div class="radio"><label><input type="radio" name="userId" value='1'/> <span id="user1">用户1</span></label></div>
	<div class="radio"><label><input type="radio" name="userId" value='2'/> <span id="user2">用户2</span></label></div>
</div>

<div class='modal-footer'>
	<button class='btn btn-default btn-small' type='button' id="btn-issue" data-dismiss="modal">确定</button>
</div>
</div>
</div>
</div>

<!--触发按钮-->
<p class="text-center" id="select_button"><button id='tooltip' type="button" class='btn btn-small btn-default' data-toggle='modal' data-toggle='tooltip' data-placement='top' title='select user' data-target='#user_select'><span>选择用户</span></button></p>
<script>$("#tooltip").tooltip('show');</script>

   <div id="chat_table">
      <div id="chat_form">
        <input type="text" class="chat_content"/>
        <button class="btn btn-small btn-link text-center" type="button" id="btn_submit" data-url="./chatMessProcess.php">发送</button>
      		<input type="hidden" name="lastId" id="lastId"/>
      		<input type="hidden" name="userId" id="userId"/>
      		<div id="content_continer"><!--  --></div>
      </div>
   </div>
</body>
<script>
var url = $("#btn_submit").data('url');
// var post_url = "./postContent.php";
var reconnection = null,reconnectionTime = 3.5 * 1000,i = 0,rand = 1,j = 0;
var backs = new Array();
backs[1] = ["./20160110120839_uvHsX.thumb.224_0.jpg","22%","94%","#E5E5E5"];
backs[2] = ["./20150806175243_VKPXa.thumb.700_0.jpg","56%","29%","#282828"];
backs[3] = ["./5025de8b77fb8_600x.jpg","50%","64%","#FFFFFF"];
backs[4] = ["./5025de8c963a2_600x.jpg","70%","37%","#27408B"];

$("#btn-issue").on('click', function(e){
	 window.v= $("input[name=userId]:checked").val();
	 if(v)
	 {
	 	$("#userId").val(v);
	  $('#select_button').html("<i class='fa fa-user fa-3x' aria-hidden='true'></i>&nbsp<span style='font-size:22px;'>"+$('#user'+v).html()+"</span>");
	  $.ajax({"type" : "POST","data" : {'userId' : v},"url" : url,"dataType" : 'text',"success" : function(response){
									return;
								}});
	  setTimeout(connect, 100);
	 }
});

	$("#btn_submit").on("click", function(e){
		if(!$('#userId').val()) alert("选择一个用户");
		else{
			  var content = $('.chat_content').val();
					if(content != '')
					{
									$.ajax({"type" : "POST","data" : {'content' : content, 'userId' : window.v},"url" : url,"dataType" : 'text',"success" : function(response){
									console.log(response);
									if(response == 'succ')
									{
										  $("#content_continer").append("<p style='text-align:right;'><span class='message_"+ j +"'></span></p>");
            $(".message_"+j).html(content);
            j++;
            $('.chat_content').val("");
									}
								}});
					}
					else alert("内容不能为空");
		}
	});

	$('.chat_content').on('focus', function(e){
		 $(document).on('keypress',function(e){
		 	 if(e.keyCode == 13) $("#btn_submit").click();
		 });
		 $(this).on('blur', function(e){
		 	$(document).unbind('keypress');
		 });
	});
</script>
<script>
function connect()
{
    if(es) es.close();
    var es = new EventSource(url);
    
    es.onmessage = function(e)
    {
    	  if(reconnection) clearTimeout(reconnection);
    	  reconnection = setTimeout(connect, reconnectionTime);
    	  processd(e.data);
    }

    es.onerror = function(e){
        console.log(e);
        // 如果服务器端关闭了套接字(后端程序执行结束)，sse会调用自己的重连机制：
        // 1. 设置es对象的一个readyState属性，值为EventSource.CONNECTING
        // 2. 调用这个onerror处理
        // 3. 等待retry延长时间(谷歌是三秒，火狐五秒)，重连

        //如果不想使用它的重连机制，用自己的，close掉（比如后端每次只发一次数据后，程序停止，然后调用自己的重连机制，20秒重练一次）
        this.close();
    }
}

function processd(data,es)
{
    try{var d = JSON.parse(data);}
    catch(exception){
        console.log(exception);
        return;
    }

    if(d) 
    {
        $("#content_continer").append("<p style='text-align:left;'><span class='_message"+ i +"'></span></p>");
        $("._message"+i).html(d.content);
        rand = Math.ceil(Math.random()*4);
								$("._message"+i).css({'background': "url("+backs[rand][0]+") no-repeat "+backs[rand][1]+" "+backs[rand][2], 'color' : backs[rand][3]});
        i++;
        $.ajax({"url" : url,'type' : 'POST','data' : {'change' : 1, 'id' : d.id},'dataType' : 'json',success : function(e){
            console.log(data);
            return;
        }});
    }
}

</script>
</html>