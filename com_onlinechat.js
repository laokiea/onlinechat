$(function(){var url=$("#btn_submit").data("url");var reconnection=null,reconnectionTime=3.5*1000,i=0,rand=1,j=0;var backs=new Array();backs[1]=["./20160110120839_uvHsX.thumb.224_0.jpg","22%","94%","#E5E5E5"];backs[2]=["./20150806175243_VKPXa.thumb.700_0.jpg","56%","29%","#282828"];backs[3]=["./5025de8b77fb8_600x.jpg","50%","64%","#FFFFFF"];backs[4]=["./5025de8c963a2_600x.jpg","70%","37%","#27408B"];checkLogin();var info=new Array();info["in"]="Sign In";info["up"]="Sign Up";$("#change").on("click",function(){var leftObj=$(this).parent().find("button[id^='btn-']").children();var curr=leftObj.html().substr(-2);var flag=(curr=="In")?"up":"in";$("input[name='action']").val(flag);leftObj.html(info[flag]);$("#sign-"+flag).show("slow");$("#sign-"+curr.toLowerCase()).hide("slow")});if(typeof $("input[name=loginedUser]").val()=="undefined"||$("input[name=loginedUser]").val()==""){localStorage.clear()}$("#btn-issue").on("click",function(e){var action=$("input[name='action']").val();if(action=="in"||action=="up"){$.ajax({"type":"POST","dataType":"text","url":"./userProcess.php?action="+$("input[name='action']").val(),"data":{"data":$("#sign-"+action).serialize()},success:function(response){var d=JSON.parse(response);console.log(d);if(d.errorCode==9){$("#isseu-out").modal()}else{$(".worng-sign").html(d.message).css({"float":"left","padding-top":"7px"})}if(typeof d.userId!=="undefined"){setTimeout("history.go(0)",1000)}}})}});$("#resignin").on("click",function(){resignin()});$(".chat_content").on("focus",function(e){$(document).on("keypress",function(e){if(e.keyCode==13){$("#btn_submit").click()}});$(this).on("blur",function(e){$(document).unbind("keypress")})});function startGetMess(){window.self=$("input[name=loginedUser]").val();window.object=localStorage.getItem("objectId");if(self&&object){$.ajax({"type":"POST","data":{"objectId":object},"url":url,"dataType":"text","success":function(response){return}});setTimeout(connect,100)}}$("#btn_submit").on("click",function(e){if(!self||!object){alert("少人！")}else{var content=$(".chat_content").val();if($.trim(content)!=""){$.ajax({"type":"POST","data":{"content":content,"userId":window.self},"url":url,"dataType":"text","success":function(response){console.log(response);if(response=="succ"){$("#content_continer").append("<p style='text-align:right;'><span class='message_"+j+"'></span></p>");$(".message_"+j).html(content);j++;$(".chat_content").val("")}}})}else{alert("内容不能为空")}}});$(".question-des").tooltip({html:true});$("#object-search").on("click",function(e){e.preventDefault();e.stopPropagation();var url=$(this).data("url");var objectName=$(this).parent().find("input[name=search_key]").val();$.ajax({"url":url,"dataType":"json","type":"POST","data":{"objectName":objectName},"success":function(response){console.log(response);if(response.result=="fail"){$("#object_select .error").html(response.message)}else{$("#object_select .error").remove();$("#object_select").hide();$(".left-top-container").fadeIn(1200).find(".user-container-left").html("<i class='fa fa-user' aria-hidden='true'></i>&nbsp&nbsp<span>"+response.objectName+"</span><span class='object-close'>&times</span>");if(window.localStorage){localStorage.setItem("objectId",response.objectId);localStorage.setItem("objectName",response.objectName)}startGetMess()}}})});startGetMess();if(typeof localStorage.getItem("objectId")!="undefined"&&localStorage.getItem("objectId")!=null){$("#object_select").css("display","none");$(".left-top-container").fadeIn(1200).find(".user-container-left").html("<i class='fa fa-user' aria-hidden='true'></i>&nbsp&nbsp<span>"+localStorage.objectName+"</span><span class='object-close'>&times</span>")}$(".sign-out").on("click",function(){localStorage.clear()});$(".object-close").on("click",function(){$("#object_select").fadeIn(1200);$(".left-top-container").hide();localStorage.clear()});function connect(){if(es){es.close()}var es=new EventSource(url);es.onmessage=function(e){if(reconnection){clearTimeout(reconnection)}reconnection=setTimeout(connect,reconnectionTime);processd(e.data)};es.onerror=function(e){console.log(e);this.close()}}function processd(data,es){try{var d=JSON.parse(data)}catch(exception){console.log(exception);return}if(d){$("#content_continer").append("<p style='text-align:left;'><span class='_message"+i+"'></span></p>");$("._message"+i).html(d.content);rand=Math.ceil(Math.random()*4);$("._message"+i).css({"background":"url("+backs[rand][0]+") no-repeat "+backs[rand][1]+" "+backs[rand][2],"color":backs[rand][3]});i++;$.ajax({"url":url,"type":"POST","data":{"change":1,"id":d.id},"dataType":"json",success:function(e){console.log(data);return}})}}function resignin(){var url="./userProcess.php?action=resignin";$.ajax({"url":url,"dataType":"json","type":"POST",success:function(response){history.go(0)}})}});